-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.abono_tipos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  descricao text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT abono_tipos_pkey PRIMARY KEY (id),
  CONSTRAINT abono_tipos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.abonos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  data_abono date NOT NULL,
  horas_abonadas numeric NOT NULL,
  observacao text,
  criado_por_usuario_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  caminho_arquivo text,
  tipo_abono_id bigint,
  organizacao_id bigint NOT NULL,
  CONSTRAINT abonos_pkey PRIMARY KEY (id),
  CONSTRAINT abonos_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT abonos_criado_por_usuario_id_fkey FOREIGN KEY (criado_por_usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT abonos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT fk_abonos_tipo FOREIGN KEY (tipo_abono_id) REFERENCES public.abono_tipos(id)
);
CREATE TABLE public.activities (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empresa_id bigint,
  empreendimento_id bigint,
  funcionario_id bigint,
  diario_obra_id bigint,
  criado_por_usuario_id uuid NOT NULL,
  etapa text,
  tipo_atividade character varying NOT NULL,
  nome text NOT NULL,
  descricao text,
  data_inicio_prevista date,
  duracao_dias numeric,
  data_fim_prevista date,
  data_inicio_real date,
  data_fim_real date,
  status character varying DEFAULT 'Não iniciado'::character varying,
  responsavel_texto text,
  dependencies text,
  custom_class text,
  created_at timestamp with time zone DEFAULT now(),
  progresso integer DEFAULT 0,
  etapa_id bigint,
  data_fim_original date,
  motivo_adiamento text,
  hora_inicio time without time zone,
  duracao_horas numeric,
  is_recorrente boolean DEFAULT false,
  recorrencia_tipo text,
  recorrencia_intervalo integer DEFAULT 1,
  recorrencia_dias_semana jsonb,
  recorrencia_fim date,
  contato_id bigint,
  atividade_pai_id bigint,
  subetapa_id bigint,
  organizacao_id bigint NOT NULL,
  CONSTRAINT activities_pkey PRIMARY KEY (id),
  CONSTRAINT activities_criado_por_usuario_id_fkey FOREIGN KEY (criado_por_usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT activities_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT activities_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT activities_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT activities_diario_obra_id_fkey FOREIGN KEY (diario_obra_id) REFERENCES public.diarios_obra(id),
  CONSTRAINT fk_etapa_obra FOREIGN KEY (etapa_id) REFERENCES public.etapa_obra(id),
  CONSTRAINT fk_activities_contato_id FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT fk_atividade_pai FOREIGN KEY (atividade_pai_id) REFERENCES public.activities(id),
  CONSTRAINT fk_activities_subetapa FOREIGN KEY (subetapa_id) REFERENCES public.subetapas(id),
  CONSTRAINT activities_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.activity_anexos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  activity_id bigint NOT NULL,
  file_name text,
  file_path text,
  file_type text,
  file_size bigint,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint,
  CONSTRAINT activity_anexos_pkey PRIMARY KEY (id),
  CONSTRAINT activity_anexos_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id),
  CONSTRAINT activity_anexos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.ajustes_banco_horas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  lancamento_financeiro_id bigint,
  minutos_ajustados integer NOT NULL,
  valor_ajustado numeric NOT NULL,
  data_ajuste date NOT NULL DEFAULT now(),
  motivo text,
  criado_por_usuario_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT ajustes_banco_horas_pkey PRIMARY KEY (id),
  CONSTRAINT ajustes_banco_horas_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT ajustes_banco_horas_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT ajustes_banco_horas_lancamento_financeiro_id_fkey FOREIGN KEY (lancamento_financeiro_id) REFERENCES public.lancamentos(id),
  CONSTRAINT ajustes_banco_horas_criado_por_usuario_id_fkey FOREIGN KEY (criado_por_usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.app_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  origem text,
  mensagem text,
  payload jsonb,
  CONSTRAINT app_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.atividades_elementos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  organizacao_id bigint NOT NULL,
  atividade_id bigint NOT NULL,
  projeto_bim_id bigint NOT NULL,
  external_id text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT atividades_elementos_pkey PRIMARY KEY (id),
  CONSTRAINT atividades_elementos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT atividades_elementos_atividade_id_fkey FOREIGN KEY (atividade_id) REFERENCES public.activities(id),
  CONSTRAINT atividades_elementos_projeto_bim_id_fkey FOREIGN KEY (projeto_bim_id) REFERENCES public.projetos_bim(id)
);
CREATE TABLE public.auditoria_ia_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  lancamento_id bigint NOT NULL,
  organizacao_id bigint NOT NULL,
  status_auditoria text NOT NULL CHECK (status_auditoria = ANY (ARRAY['Pendente'::text, 'Aprovado'::text, 'Divergente'::text, 'Erro'::text])),
  valor_identificado numeric,
  valor_lancamento numeric,
  diferenca numeric,
  confianca_ia numeric,
  analise_ia text,
  caminhos_arquivos ARRAY,
  modelo_ia text DEFAULT 'gemini-1.5-flash'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT auditoria_ia_logs_pkey PRIMARY KEY (id),
  CONSTRAINT fk_auditoria_lancamento FOREIGN KEY (lancamento_id) REFERENCES public.lancamentos(id),
  CONSTRAINT fk_auditoria_organizacao FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.automacoes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  nome text NOT NULL,
  gatilho_tipo text NOT NULL,
  gatilho_config jsonb,
  acao_tipo text NOT NULL,
  acao_config jsonb,
  ativo boolean NOT NULL DEFAULT true,
  organizacao_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT automacoes_pkey PRIMARY KEY (id),
  CONSTRAINT automacoes_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.banco_de_horas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  mes_referencia date NOT NULL,
  saldo_minutos integer NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['Fechado'::text, 'Pago'::text, 'Descontado'::text])),
  lancamento_id bigint,
  criado_em timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT banco_de_horas_pkey PRIMARY KEY (id),
  CONSTRAINT banco_de_horas_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT banco_de_horas_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT banco_de_horas_lancamento_id_fkey FOREIGN KEY (lancamento_id) REFERENCES public.lancamentos(id)
);
CREATE TABLE public.bim_vistas_federadas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome text NOT NULL,
  organizacao_id bigint NOT NULL,
  empreendimento_id bigint NOT NULL,
  modelos_urns ARRAY NOT NULL,
  camera_state jsonb,
  criado_em timestamp with time zone DEFAULT now(),
  criado_por uuid DEFAULT auth.uid(),
  CONSTRAINT bim_vistas_federadas_pkey PRIMARY KEY (id),
  CONSTRAINT bim_vistas_federadas_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT bim_vistas_federadas_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT bim_vistas_federadas_criado_por_fkey FOREIGN KEY (criado_por) REFERENCES auth.users(id)
);
CREATE TABLE public.cadastro_empresa (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  cnpj text NOT NULL UNIQUE,
  razao_social text NOT NULL,
  nome_fantasia text,
  inscricao_estadual text,
  inscricao_municipal text,
  address_street text,
  address_number text,
  address_complement text,
  cep character varying,
  city text,
  state character varying,
  neighborhood text,
  telefone character varying,
  email text,
  responsavel_legal text,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  meta_business_id text,
  objeto_social text,
  capital_social numeric,
  natureza_juridica text,
  CONSTRAINT cadastro_empresa_pkey PRIMARY KEY (id),
  CONSTRAINT cadastro_empresa_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.campos_sistema (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  tabela_id bigint NOT NULL,
  nome_coluna text NOT NULL,
  nome_exibicao text NOT NULL,
  tipo_dado text,
  visivel_listagem boolean DEFAULT true,
  visivel_filtro boolean DEFAULT true,
  editavel boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT campos_sistema_pkey PRIMARY KEY (id),
  CONSTRAINT fk_campo_tabela FOREIGN KEY (tabela_id) REFERENCES public.tabelas_sistema(id)
);
CREATE TABLE public.cargos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome text NOT NULL,
  descricao text,
  cbo text,
  organizacao_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT cargos_pkey PRIMARY KEY (id),
  CONSTRAINT cargos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.categorias_financeiras (
  id bigint NOT NULL DEFAULT nextval('categorias_financeiras_id_seq'::regclass),
  nome text NOT NULL,
  tipo text NOT NULL CHECK (tipo = ANY (ARRAY['Receita'::text, 'Despesa'::text])),
  created_at timestamp with time zone DEFAULT now(),
  parent_id bigint,
  organizacao_id bigint NOT NULL,
  CONSTRAINT categorias_financeiras_pkey PRIMARY KEY (id),
  CONSTRAINT categorias_financeiras_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.categorias_financeiras(id),
  CONSTRAINT categorias_financeiras_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.chat_conversations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT chat_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT chat_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT chat_conversations_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.chat_messages (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  conversation_id uuid,
  sender_type text NOT NULL CHECK (sender_type = ANY (ARRAY['user'::text, 'ai'::text])),
  message_content text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chat_messages_pkey PRIMARY KEY (id),
  CONSTRAINT chat_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chat_conversations(id)
);
CREATE TABLE public.colunas_funil (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  funil_id uuid NOT NULL,
  nome character varying NOT NULL,
  ordem integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  cor text DEFAULT 'bg-gray-100'::text,
  CONSTRAINT colunas_funil_pkey PRIMARY KEY (id),
  CONSTRAINT colunas_funil_funil_id_fkey FOREIGN KEY (funil_id) REFERENCES public.funis(id),
  CONSTRAINT colunas_funil_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.conciliacao_historico (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  data_conciliacao timestamp with time zone NOT NULL DEFAULT now(),
  usuario_id uuid NOT NULL,
  conta_financeira_id bigint NOT NULL,
  organizacao_id bigint NOT NULL,
  caminho_arquivo_ofx text NOT NULL,
  periodo_inicio_extrato date NOT NULL,
  periodo_fim_extrato date NOT NULL,
  lancamentos_conciliados jsonb,
  total_conciliado numeric NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT conciliacao_historico_pkey PRIMARY KEY (id),
  CONSTRAINT conciliacao_historico_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT conciliacao_historico_conta_financeira_id_fkey FOREIGN KEY (conta_financeira_id) REFERENCES public.contas_financeiras(id),
  CONSTRAINT conciliacao_historico_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.configuracoes_belvo (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  organizacao_id bigint NOT NULL UNIQUE,
  secret_id text NOT NULL,
  secret_password text NOT NULL,
  environment text DEFAULT 'sandbox'::text CHECK (environment = ANY (ARRAY['sandbox'::text, 'production'::text, 'development'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT configuracoes_belvo_pkey PRIMARY KEY (id),
  CONSTRAINT configuracoes_belvo_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.configuracoes_ia (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome text NOT NULL DEFAULT 'stella_whatsapp'::text UNIQUE,
  system_prompt text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT configuracoes_ia_pkey PRIMARY KEY (id)
);
CREATE TABLE public.configuracoes_venda (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL UNIQUE,
  percentual_entrada numeric,
  num_parcelas_entrada integer,
  data_inicio_entrada date,
  percentual_obra numeric,
  num_parcelas_obra integer,
  data_inicio_obra date,
  percentual_saldo_remanescente numeric,
  created_at timestamp with time zone DEFAULT now(),
  valor_cub numeric,
  desconto_percentual numeric,
  entrada_percentual numeric,
  parcelas_obra_percentual numeric,
  saldo_remanescente_percentual numeric,
  data_primeira_parcela_entrada date,
  data_primeira_parcela_obra date,
  organizacao_id bigint,
  CONSTRAINT configuracoes_venda_pkey PRIMARY KEY (id),
  CONSTRAINT configuracoes_venda_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT configuracoes_venda_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.configuracoes_whatsapp (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empresa_id bigint NOT NULL UNIQUE,
  whatsapp_phone_number_id text,
  whatsapp_business_account_id text,
  whatsapp_permanent_token text,
  verify_token text,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint,
  CONSTRAINT configuracoes_whatsapp_pkey PRIMARY KEY (id),
  CONSTRAINT configuracoes_whatsapp_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT configuracoes_whatsapp_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.contas_financeiras (
  id bigint NOT NULL DEFAULT nextval('contas_financeiras_id_seq'::regclass),
  nome text NOT NULL,
  tipo text NOT NULL,
  saldo_inicial numeric NOT NULL DEFAULT 0,
  instituicao text,
  empresa_id bigint,
  created_at timestamp with time zone DEFAULT now(),
  agencia text,
  numero_conta text,
  chaves_pix jsonb,
  limite_cheque_especial numeric,
  limite_credito numeric,
  dia_fechamento_fatura integer CHECK (dia_fechamento_fatura >= 1 AND dia_fechamento_fatura <= 31),
  dia_pagamento_fatura integer CHECK (dia_pagamento_fatura >= 1 AND dia_pagamento_fatura <= 31),
  conta_debito_fatura_id bigint,
  organizacao_id bigint NOT NULL,
  pluggy_item_id text,
  pluggy_account_id text,
  belvo_link_id text,
  belvo_account_id text,
  CONSTRAINT contas_financeiras_pkey PRIMARY KEY (id),
  CONSTRAINT contas_financeiras_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT contas_financeiras_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT fk_conta_debito_fatura FOREIGN KEY (conta_debito_fatura_id) REFERENCES public.contas_financeiras(id)
);
CREATE TABLE public.contatos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empresa_id bigint,
  nome text,
  cargo text,
  address_street text,
  address_number text,
  address_complement text,
  cep character varying,
  city text,
  state character varying,
  neighborhood text,
  created_at timestamp with time zone DEFAULT now(),
  tipo_contato USER-DEFINED,
  foto_url text,
  razao_social text,
  nome_fantasia text,
  cnpj text,
  inscricao_estadual text,
  inscricao_municipal text,
  responsavel_legal text,
  cpf text,
  rg text,
  birth_date date,
  estado_civil text,
  contract_role text,
  admission_date date,
  demission_date date,
  status text DEFAULT 'Ativo'::text,
  base_salary text,
  total_salary text,
  daily_value text,
  payment_method text,
  pix_key text,
  bank_details text,
  observations text,
  numero_ponto integer UNIQUE,
  nacionalidade text,
  personalidade_juridica text,
  data_fundacao date,
  tipo_servico_produto text,
  pessoa_contato text,
  objetivo text,
  is_awaiting_name_response boolean DEFAULT false,
  origem text,
  meta_lead_id text UNIQUE,
  meta_ad_id text,
  meta_adgroup_id text,
  meta_page_id text,
  meta_form_id text,
  meta_created_time timestamp with time zone,
  meta_form_data jsonb,
  organizacao_id bigint NOT NULL,
  meta_ad_name text,
  conjuge_id bigint,
  regime_bens text,
  meta_campaign_id text,
  meta_campaign_name text,
  meta_adset_name text,
  criado_por uuid,
  criado_por_usuario_id uuid,
  creci text,
  lixeira boolean DEFAULT false,
  renda_familiar numeric,
  terceirizado_ativo boolean DEFAULT false,
  fgts boolean DEFAULT false,
  mais_de_3_anos_clt boolean DEFAULT false,
  CONSTRAINT contatos_pkey PRIMARY KEY (id),
  CONSTRAINT contatos_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT contatos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT contatos_conjuge_id_fkey FOREIGN KEY (conjuge_id) REFERENCES public.contatos(id),
  CONSTRAINT contatos_criado_por_fkey FOREIGN KEY (criado_por) REFERENCES public.usuarios(id),
  CONSTRAINT contatos_criado_por_usuario_id_fkey FOREIGN KEY (criado_por_usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.contatos_no_funil (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  contato_id bigint NOT NULL UNIQUE,
  coluna_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  numero_card integer,
  produto_id bigint,
  simulacao_id bigint,
  corretor_id bigint,
  organizacao_id bigint NOT NULL,
  CONSTRAINT contatos_no_funil_pkey PRIMARY KEY (id),
  CONSTRAINT contatos_no_funil_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT contatos_no_funil_coluna_id_fkey FOREIGN KEY (coluna_id) REFERENCES public.colunas_funil(id),
  CONSTRAINT contatos_no_funil_produto_id_fkey FOREIGN KEY (produto_id) REFERENCES public.produtos_empreendimento(id),
  CONSTRAINT contatos_no_funil_simulacao_id_fkey FOREIGN KEY (simulacao_id) REFERENCES public.simulacoes(id),
  CONSTRAINT fk_contatos_no_funil_corretor_id FOREIGN KEY (corretor_id) REFERENCES public.contatos(id),
  CONSTRAINT contatos_no_funil_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.contatos_no_funil_produtos (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  contato_no_funil_id uuid NOT NULL,
  produto_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint,
  CONSTRAINT contatos_no_funil_produtos_pkey PRIMARY KEY (id),
  CONSTRAINT fk_contato_no_funil FOREIGN KEY (contato_no_funil_id) REFERENCES public.contatos_no_funil(id),
  CONSTRAINT fk_produto FOREIGN KEY (produto_id) REFERENCES public.produtos_empreendimento(id),
  CONSTRAINT contatos_no_funil_produtos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.contracheques (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  mes_referencia date NOT NULL,
  salario_base numeric DEFAULT 0,
  valor_diaria_base numeric DEFAULT 0,
  dias_trabalhados integer DEFAULT 0,
  valor_total_diarias numeric DEFAULT 0,
  bonus numeric DEFAULT 0,
  salario_bruto numeric DEFAULT 0,
  faixa_inss numeric,
  desconto_inss numeric DEFAULT 0,
  base_calculo_fgts numeric DEFAULT 0,
  valor_fgts numeric DEFAULT 0,
  base_calculo_irrf numeric DEFAULT 0,
  outros_descontos numeric DEFAULT 0,
  adicionais numeric DEFAULT 0,
  custo_inss_patronal numeric DEFAULT 0,
  custo_rat numeric DEFAULT 0,
  custo_terceiros numeric DEFAULT 0,
  valor_liquido numeric DEFAULT (((salario_bruto + adicionais) - desconto_inss) - outros_descontos),
  status text NOT NULL DEFAULT 'Pendente'::text,
  observacoes text,
  criado_em timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT contracheques_pkey PRIMARY KEY (id),
  CONSTRAINT contracheques_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT contracheques_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.contrato_anexos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contrato_id bigint NOT NULL,
  tipo_documento text NOT NULL,
  caminho_arquivo text NOT NULL,
  nome_arquivo text NOT NULL,
  usuario_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  organizacao_id bigint,
  CONSTRAINT contrato_anexos_pkey PRIMARY KEY (id),
  CONSTRAINT contrato_anexos_contrato_id_fkey FOREIGN KEY (contrato_id) REFERENCES public.contratos(id),
  CONSTRAINT contrato_anexos_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id),
  CONSTRAINT contrato_anexos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.contrato_parcelas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contrato_id bigint NOT NULL,
  descricao text NOT NULL,
  tipo text NOT NULL,
  data_vencimento date NOT NULL,
  valor_parcela numeric NOT NULL,
  status_pagamento text NOT NULL DEFAULT 'Pendente'::text,
  lancamento_id bigint,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint,
  CONSTRAINT contrato_parcelas_pkey PRIMARY KEY (id),
  CONSTRAINT contrato_parcelas_contrato_id_fkey FOREIGN KEY (contrato_id) REFERENCES public.contratos(id),
  CONSTRAINT contrato_parcelas_lancamento_id_fkey FOREIGN KEY (lancamento_id) REFERENCES public.lancamentos(id),
  CONSTRAINT contrato_parcelas_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.contrato_permutas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contrato_id bigint NOT NULL,
  descricao text NOT NULL,
  valor numeric NOT NULL DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  data_registro date NOT NULL DEFAULT now(),
  valor_permutado numeric NOT NULL DEFAULT 0,
  organizacao_id bigint,
  CONSTRAINT contrato_permutas_pkey PRIMARY KEY (id),
  CONSTRAINT contrato_permutas_contrato_id_fkey FOREIGN KEY (contrato_id) REFERENCES public.contratos(id),
  CONSTRAINT contrato_permutas_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.contrato_produtos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contrato_id bigint NOT NULL,
  produto_id bigint NOT NULL,
  organizacao_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT contrato_produtos_pkey PRIMARY KEY (id),
  CONSTRAINT contrato_produtos_contrato_id_fkey FOREIGN KEY (contrato_id) REFERENCES public.contratos(id),
  CONSTRAINT contrato_produtos_produto_id_fkey FOREIGN KEY (produto_id) REFERENCES public.produtos_empreendimento(id),
  CONSTRAINT contrato_produtos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.contratos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contato_id bigint,
  produto_id bigint,
  empreendimento_id bigint,
  data_venda date NOT NULL DEFAULT CURRENT_DATE,
  valor_final_venda numeric NOT NULL,
  status_contrato text NOT NULL DEFAULT 'Em assinatura'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  simulacao_id bigint,
  corretor_id bigint,
  indice_reajuste text,
  multa_inadimplencia_percentual numeric,
  juros_mora_inadimplencia_percentual numeric,
  clausula_penal_percentual numeric,
  numero_contrato integer UNIQUE,
  organizacao_id bigint NOT NULL,
  percentual_comissao_corretagem numeric,
  valor_comissao_corretagem numeric,
  forma_pagamento_corretagem text,
  observacoes_contrato text,
  conjuge_id bigint,
  regime_bens text,
  representante_id bigint,
  conta_bancaria_id bigint,
  criado_por_usuario_id uuid,
  modelo_contrato_id bigint,
  tipo_documento text NOT NULL DEFAULT 'CONTRATO'::text,
  lixeira boolean DEFAULT false,
  CONSTRAINT contratos_pkey PRIMARY KEY (id),
  CONSTRAINT contratos_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT contratos_produto_id_fkey FOREIGN KEY (produto_id) REFERENCES public.produtos_empreendimento(id),
  CONSTRAINT contratos_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT contratos_simulacao_id_fkey FOREIGN KEY (simulacao_id) REFERENCES public.simulacoes(id),
  CONSTRAINT contratos_corretor_id_fkey FOREIGN KEY (corretor_id) REFERENCES public.contatos(id),
  CONSTRAINT contratos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT contratos_conjuge_id_fkey FOREIGN KEY (conjuge_id) REFERENCES public.contatos(id),
  CONSTRAINT contratos_representante_id_fkey FOREIGN KEY (representante_id) REFERENCES public.contatos(id),
  CONSTRAINT contratos_conta_bancaria_id_fkey FOREIGN KEY (conta_bancaria_id) REFERENCES public.contas_financeiras(id),
  CONSTRAINT contratos_criado_por_usuario_id_fkey FOREIGN KEY (criado_por_usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT contratos_modelo_contrato_id_fkey FOREIGN KEY (modelo_contrato_id) REFERENCES public.modelos_contrato(id)
);
CREATE TABLE public.contratos_terceirizados (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  fornecedor_id bigint NOT NULL,
  titulo text NOT NULL,
  data_inicio date NOT NULL,
  data_fim date,
  valor_total numeric,
  descricao text,
  status text DEFAULT 'Ativo'::text,
  CONSTRAINT contratos_terceirizados_pkey PRIMARY KEY (id),
  CONSTRAINT contratos_terceirizados_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT contratos_terceirizados_fornecedor_id_fkey FOREIGN KEY (fornecedor_id) REFERENCES public.contatos(id)
);
CREATE TABLE public.contratos_terceirizados_anexos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  contrato_id bigint NOT NULL,
  nome_arquivo text NOT NULL,
  caminho_arquivo text NOT NULL,
  tipo_arquivo text,
  tamanho_bytes bigint,
  uploaded_by uuid,
  tipo_documento_id bigint,
  descricao text,
  CONSTRAINT contratos_terceirizados_anexos_pkey PRIMARY KEY (id),
  CONSTRAINT contratos_terceirizados_anexos_contrato_id_fkey FOREIGN KEY (contrato_id) REFERENCES public.contratos_terceirizados(id),
  CONSTRAINT contratos_terceirizados_anexos_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES auth.users(id),
  CONSTRAINT contratos_terceirizados_anexos_tipo_documento_id_fkey FOREIGN KEY (tipo_documento_id) REFERENCES public.documento_tipos(id)
);
CREATE TABLE public.crm_notas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  contato_no_funil_id uuid NOT NULL,
  contato_id bigint NOT NULL,
  conteudo text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  usuario_id uuid,
  organizacao_id bigint,
  CONSTRAINT crm_notas_pkey PRIMARY KEY (id),
  CONSTRAINT crm_notas_contato_no_funil_id_fkey FOREIGN KEY (contato_no_funil_id) REFERENCES public.contatos_no_funil(id),
  CONSTRAINT crm_notas_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT crm_notas_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT crm_notas_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.debug_notificacoes (
  id integer NOT NULL DEFAULT nextval('debug_notificacoes_id_seq'::regclass),
  data_hora timestamp without time zone DEFAULT now(),
  tabela text,
  regra_id integer,
  nome_regra text,
  valor_novo text,
  valor_gatilho text,
  passou_no_filtro boolean,
  coluna_monitorada text,
  CONSTRAINT debug_notificacoes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.diarios_obra (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  data_relatorio character varying NOT NULL,
  rdo_numero character varying,
  responsavel_rdo text,
  condicoes_climaticas text,
  condicoes_trabalho text,
  status_atividades jsonb,
  mao_de_obra jsonb,
  ocorrencias_do_dia jsonb,
  fotos_do_dia jsonb,
  created_at timestamp with time zone DEFAULT now(),
  usuario_responsavel_id uuid,
  organizacao_id bigint NOT NULL,
  pdf_url text,
  CONSTRAINT diarios_obra_pkey PRIMARY KEY (id),
  CONSTRAINT diarios_obra_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT fk_usuario_responsavel FOREIGN KEY (usuario_responsavel_id) REFERENCES public.usuarios(id),
  CONSTRAINT diarios_obra_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.disciplinas_projetos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  sigla text NOT NULL,
  nome text NOT NULL,
  organizacao_id bigint NOT NULL DEFAULT 2,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT disciplinas_projetos_pkey PRIMARY KEY (id),
  CONSTRAINT disciplinas_projetos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.documento_tipos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  sigla text NOT NULL,
  descricao text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT documento_tipos_pkey PRIMARY KEY (id),
  CONSTRAINT documento_tipos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.documentos_funcionarios (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  nome_documento text NOT NULL,
  caminho_arquivo text NOT NULL,
  data_upload timestamp with time zone DEFAULT now(),
  criado_por_usuario_id uuid,
  tipo_documento_id bigint,
  organizacao_id bigint NOT NULL,
  CONSTRAINT documentos_funcionarios_pkey PRIMARY KEY (id),
  CONSTRAINT documentos_funcionarios_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT documentos_funcionarios_criado_por_usuario_id_fkey FOREIGN KEY (criado_por_usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT documentos_funcionarios_tipo_documento_id_fkey FOREIGN KEY (tipo_documento_id) REFERENCES public.documento_tipos(id),
  CONSTRAINT documentos_funcionarios_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.elementos_bim (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organizacao_id bigint NOT NULL,
  projeto_bim_id bigint NOT NULL,
  external_id text NOT NULL,
  categoria text,
  familia text,
  tipo text,
  nivel text,
  propriedades jsonb DEFAULT '{}'::jsonb,
  status_execucao text DEFAULT 'nao_iniciado'::text,
  criado_em timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  atualizado_em timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  urn_autodesk text,
  CONSTRAINT elementos_bim_pkey PRIMARY KEY (id),
  CONSTRAINT elementos_bim_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT elementos_bim_projeto_bim_id_fkey FOREIGN KEY (projeto_bim_id) REFERENCES public.projetos_bim(id)
);
CREATE TABLE public.email_configuracoes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  organizacao_id bigint NOT NULL,
  email text NOT NULL,
  nome_remetente text,
  imap_host text NOT NULL,
  imap_port integer NOT NULL DEFAULT 993,
  imap_user text NOT NULL,
  smtp_host text NOT NULL,
  smtp_port integer NOT NULL DEFAULT 465,
  smtp_user text NOT NULL,
  senha_app text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  assinatura_texto text DEFAULT ''::text,
  assinatura_usar_novos boolean DEFAULT true,
  assinatura_usar_respostas boolean DEFAULT true,
  assinatura_incluir_foto boolean DEFAULT true,
  conta_apelido text,
  last_sync_uid bigint DEFAULT 0,
  CONSTRAINT email_configuracoes_pkey PRIMARY KEY (id),
  CONSTRAINT email_configuracoes_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT email_configuracoes_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.email_folders_cache (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  account_id uuid NOT NULL,
  path text NOT NULL,
  name text NOT NULL,
  display_name text,
  unseen_count integer DEFAULT 0,
  total_count integer DEFAULT 0,
  parent_path text,
  level integer DEFAULT 0,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_folders_cache_pkey PRIMARY KEY (id),
  CONSTRAINT email_folders_cache_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.email_configuracoes(id)
);
CREATE TABLE public.email_messages (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  user_id uuid NOT NULL,
  organizacao_id bigint NOT NULL,
  uid bigint NOT NULL,
  folder text NOT NULL,
  subject text,
  from_name text,
  from_address text,
  to_address text,
  date timestamp with time zone,
  body_preview text,
  flags jsonb DEFAULT '[]'::jsonb,
  is_read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_messages_pkey PRIMARY KEY (id),
  CONSTRAINT email_messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT email_messages_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.email_messages_cache (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  account_id uuid NOT NULL,
  uid bigint NOT NULL,
  folder_path text NOT NULL,
  subject text,
  from_text text,
  to_text text,
  date timestamp with time zone,
  preview text,
  html_body text,
  text_body text,
  flags jsonb DEFAULT '[]'::jsonb,
  has_attachments boolean DEFAULT false,
  attachments_meta jsonb DEFAULT '[]'::jsonb,
  is_read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  conteudo_cache jsonb,
  cc_text text,
  bcc_text text,
  CONSTRAINT email_messages_cache_pkey PRIMARY KEY (id),
  CONSTRAINT email_messages_cache_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.email_configuracoes(id)
);
CREATE TABLE public.email_regras (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  user_id uuid NOT NULL,
  organizacao_id bigint,
  nome text NOT NULL,
  ativo boolean DEFAULT true,
  ordem integer DEFAULT 0,
  condicoes jsonb NOT NULL DEFAULT '[]'::jsonb,
  acoes jsonb NOT NULL DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  account_id uuid,
  CONSTRAINT email_regras_pkey PRIMARY KEY (id),
  CONSTRAINT email_regras_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT email_regras_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT email_regras_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.email_configuracoes(id)
);
CREATE TABLE public.emails (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contato_id bigint NOT NULL,
  email text NOT NULL,
  tipo text,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint,
  CONSTRAINT emails_pkey PRIMARY KEY (id),
  CONSTRAINT emails_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT emails_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.empreendimento_anexos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  tipo_documento_id bigint,
  caminho_arquivo text NOT NULL,
  nome_arquivo text,
  descricao text,
  usuario_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  titulo text,
  categoria_aba text,
  usar_para_pesquisa boolean DEFAULT false,
  pode_enviar_anexo boolean DEFAULT false,
  status text DEFAULT 'Pendente'::text,
  organizacao_id bigint,
  thumbnail_url text,
  empresa_id bigint,
  disponivel_corretor boolean DEFAULT false,
  CONSTRAINT empreendimento_anexos_pkey PRIMARY KEY (id),
  CONSTRAINT empreendimento_anexos_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT empreendimento_anexos_tipo_documento_id_fkey FOREIGN KEY (tipo_documento_id) REFERENCES public.documento_tipos(id),
  CONSTRAINT empreendimento_anexos_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id),
  CONSTRAINT empreendimento_anexos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT fk_empreendimento_anexos_empresa FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id)
);
CREATE TABLE public.empreendimento_documento_embeddings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  empreendimento_id bigint NOT NULL,
  anexo_id bigint NOT NULL,
  content text NOT NULL,
  embedding USER-DEFINED NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT empreendimento_documento_embeddings_pkey PRIMARY KEY (id),
  CONSTRAINT empreendimento_documento_embeddings_anexo_id_fkey FOREIGN KEY (anexo_id) REFERENCES public.empreendimento_anexos(id),
  CONSTRAINT empreendimento_documento_embeddings_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id)
);
CREATE TABLE public.empreendimentos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empresa_proprietaria_id bigint NOT NULL,
  nome text NOT NULL UNIQUE,
  address_street text,
  address_number text,
  address_complement text,
  cep character varying,
  city text,
  state character varying,
  neighborhood text,
  data_inicio character varying,
  data_fim_prevista character varying,
  status character varying DEFAULT 'Em Andamento'::character varying,
  valor_total character varying,
  created_at timestamp with time zone DEFAULT now(),
  incorporadora_id bigint,
  construtora_id bigint,
  nome_empreendimento text,
  matricula_numero character varying,
  matricula_cartorio text,
  terreno_area_total character varying,
  estrutura_tipo text,
  alvenaria_tipo text,
  cobertura_detalhes text,
  acabamentos jsonb,
  unidades jsonb,
  prazo_entrega text,
  indice_reajuste text,
  dados_contrato text,
  listado_para_venda boolean DEFAULT false,
  organizacao_id bigint NOT NULL,
  imagem_capa_url text,
  logo_url text,
  thumbnail_url text,
  observacoes text,
  CONSTRAINT empreendimentos_pkey PRIMARY KEY (id),
  CONSTRAINT empreendimentos_empresa_proprietaria_id_fkey FOREIGN KEY (empresa_proprietaria_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT empreendimentos_incorporadora_id_fkey FOREIGN KEY (incorporadora_id) REFERENCES public.contatos(id),
  CONSTRAINT empreendimentos_construtora_id_fkey FOREIGN KEY (construtora_id) REFERENCES public.contatos(id),
  CONSTRAINT empreendimentos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.empresa_anexos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empresa_id bigint NOT NULL,
  organizacao_id bigint NOT NULL,
  caminho_arquivo text NOT NULL,
  nome_arquivo text,
  descricao text,
  tipo_documento_id bigint,
  categoria_aba text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  thumbnail_url text,
  conteudo_extraido text,
  CONSTRAINT empresa_anexos_pkey PRIMARY KEY (id),
  CONSTRAINT empresa_anexos_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT empresa_anexos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT empresa_anexos_tipo_documento_id_fkey FOREIGN KEY (tipo_documento_id) REFERENCES public.documento_tipos(id)
);
CREATE TABLE public.estoque (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  material_id bigint NOT NULL,
  quantidade_atual numeric NOT NULL DEFAULT 0,
  unidade_medida text,
  custo_medio numeric NOT NULL DEFAULT 0,
  ultima_atualizacao timestamp with time zone NOT NULL DEFAULT now(),
  quantidade_em_uso numeric NOT NULL DEFAULT 0,
  organizacao_id bigint NOT NULL,
  CONSTRAINT estoque_pkey PRIMARY KEY (id),
  CONSTRAINT estoque_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT estoque_material_id_fkey FOREIGN KEY (material_id) REFERENCES public.materiais(id),
  CONSTRAINT estoque_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.estoque_obra (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  material_id bigint NOT NULL,
  quantidade numeric DEFAULT 0,
  ultima_atualizacao timestamp with time zone DEFAULT now(),
  CONSTRAINT estoque_obra_pkey PRIMARY KEY (id),
  CONSTRAINT estoque_obra_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT estoque_obra_material_id_fkey FOREIGN KEY (material_id) REFERENCES public.materiais(id)
);
CREATE TABLE public.etapa_obra (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome_etapa text NOT NULL,
  codigo_etapa text,
  custo_previsto numeric,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT etapa_obra_pkey PRIMARY KEY (id),
  CONSTRAINT etapa_obra_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.fechamentos_ponto (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  mes_referencia date NOT NULL,
  dias_trabalhados integer NOT NULL DEFAULT 0,
  valor_diaria_base numeric NOT NULL,
  valor_bruto_calculado numeric NOT NULL,
  descontos numeric DEFAULT 0,
  adicionais numeric DEFAULT 0,
  valor_liquido_a_pagar numeric DEFAULT ((valor_bruto_calculado + adicionais) - descontos),
  status text NOT NULL DEFAULT 'Pendente'::text,
  data_pagamento date,
  lancamento_id bigint,
  observacoes text,
  criado_em timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT fechamentos_ponto_pkey PRIMARY KEY (id),
  CONSTRAINT fechamentos_ponto_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT fechamentos_ponto_lancamento_id_fkey FOREIGN KEY (lancamento_id) REFERENCES public.lancamentos(id),
  CONSTRAINT fechamentos_ponto_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.feedback (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  usuario_id uuid,
  pagina text,
  descricao text NOT NULL,
  status text DEFAULT 'Aberto'::text,
  captura_de_tela_url text,
  organizacao_id bigint NOT NULL,
  CONSTRAINT feedback_pkey PRIMARY KEY (id),
  CONSTRAINT feedback_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT feedback_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.feriados (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  data_feriado date NOT NULL,
  descricao text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  tipo text NOT NULL DEFAULT 'Integral'::text CHECK (tipo = ANY (ARRAY['Integral'::text, 'Meio Período'::text])),
  organizacao_id bigint NOT NULL,
  CONSTRAINT feriados_pkey PRIMARY KEY (id),
  CONSTRAINT feriados_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.filtros_salvos_usuarios (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  organizacao_id bigint NOT NULL,
  pagina text NOT NULL,
  nome_filtro text NOT NULL,
  configuracoes jsonb NOT NULL,
  e_favorito boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT filtros_salvos_usuarios_pkey PRIMARY KEY (id),
  CONSTRAINT filtros_salvos_usuarios_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT filtros_salvos_usuarios_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.funcionarios (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empresa_id bigint NOT NULL,
  empreendimento_atual_id bigint,
  full_name text NOT NULL,
  cpf character varying NOT NULL,
  rg character varying,
  birth_date character varying,
  phone character varying,
  email text,
  address_street text,
  address_number text,
  address_complement text,
  cep character varying,
  city text,
  state character varying,
  neighborhood text,
  admission_date character varying NOT NULL,
  base_salary character varying,
  total_salary character varying,
  daily_value character varying,
  payment_method text,
  pix_key text,
  bank_details text,
  aso_doc text,
  contract_doc text,
  identity_doc text,
  observations text,
  created_at timestamp with time zone DEFAULT now(),
  foto_url text,
  estado_civil text,
  status text DEFAULT 'Ativo'::text,
  demission_date date,
  numero_ponto integer UNIQUE,
  jornada_id bigint,
  contato_id bigint UNIQUE,
  organizacao_id bigint NOT NULL,
  cargo_id bigint,
  CONSTRAINT funcionarios_pkey PRIMARY KEY (id),
  CONSTRAINT funcionarios_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT funcionarios_empreendimento_atual_id_fkey FOREIGN KEY (empreendimento_atual_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT funcionarios_jornada_id_fkey FOREIGN KEY (jornada_id) REFERENCES public.jornadas(id),
  CONSTRAINT funcionarios_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT fk_funcionarios_contato_id FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT funcionarios_cargo_id_fkey FOREIGN KEY (cargo_id) REFERENCES public.cargos(id)
);
CREATE TABLE public.funcoes (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome_funcao text NOT NULL,
  descricao text,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT funcoes_pkey PRIMARY KEY (id),
  CONSTRAINT funcoes_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.funis (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  empreendimento_id bigint,
  nome character varying NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT funis_pkey PRIMARY KEY (id),
  CONSTRAINT funis_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT funis_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.historico_movimentacao_funil (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  contato_no_funil_id uuid NOT NULL,
  coluna_anterior_id uuid,
  coluna_nova_id uuid,
  usuario_id uuid,
  data_movimentacao timestamp with time zone NOT NULL DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT historico_movimentacao_funil_pkey PRIMARY KEY (id),
  CONSTRAINT historico_movimentacao_funil_contato_no_funil_id_fkey FOREIGN KEY (contato_no_funil_id) REFERENCES public.contatos_no_funil(id),
  CONSTRAINT historico_movimentacao_funil_coluna_anterior_id_fkey FOREIGN KEY (coluna_anterior_id) REFERENCES public.colunas_funil(id),
  CONSTRAINT historico_movimentacao_funil_coluna_nova_id_fkey FOREIGN KEY (coluna_nova_id) REFERENCES public.colunas_funil(id),
  CONSTRAINT historico_movimentacao_funil_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT historico_movimentacao_funil_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.historico_salarial (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  data_inicio_vigencia date NOT NULL,
  salario_base numeric,
  valor_diaria numeric,
  motivo_alteracao text,
  criado_em timestamp with time zone DEFAULT now(),
  criado_por_usuario_id uuid,
  organizacao_id bigint NOT NULL,
  CONSTRAINT historico_salarial_pkey PRIMARY KEY (id),
  CONSTRAINT historico_salarial_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT historico_salarial_criado_por_usuario_id_fkey FOREIGN KEY (criado_por_usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT historico_salarial_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.indices_financeiros (
  id bigint NOT NULL DEFAULT nextval('indices_financeiros_id_seq'::regclass),
  nome_indice text NOT NULL UNIQUE,
  descricao text,
  configuracao_filtro jsonb NOT NULL,
  criado_em timestamp with time zone DEFAULT now(),
  criado_por uuid,
  CONSTRAINT indices_financeiros_pkey PRIMARY KEY (id),
  CONSTRAINT indices_financeiros_criado_por_fkey FOREIGN KEY (criado_por) REFERENCES public.usuarios(id)
);
CREATE TABLE public.jornada_detalhes (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  jornada_id bigint NOT NULL,
  dia_semana integer NOT NULL,
  horario_entrada time without time zone,
  horario_saida_intervalo time without time zone,
  horario_volta_intervalo time without time zone,
  horario_saida time without time zone,
  horas_feriado numeric,
  organizacao_id bigint,
  CONSTRAINT jornada_detalhes_pkey PRIMARY KEY (id),
  CONSTRAINT jornada_detalhes_jornada_id_fkey FOREIGN KEY (jornada_id) REFERENCES public.jornadas(id),
  CONSTRAINT jornada_detalhes_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.jornadas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome_jornada text NOT NULL,
  carga_horaria_semanal numeric NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  tolerancia_minutos integer DEFAULT 5,
  organizacao_id bigint NOT NULL,
  CONSTRAINT jornadas_pkey PRIMARY KEY (id),
  CONSTRAINT jornadas_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.kpis_personalizados (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  usuario_id uuid NOT NULL,
  titulo text NOT NULL,
  descricao text,
  modulo text NOT NULL,
  tipo_calculo text NOT NULL,
  filtros jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  exibir_no_painel boolean NOT NULL DEFAULT true,
  grupo text,
  organizacao_id bigint NOT NULL,
  tipo_kpi text DEFAULT 'financeiro'::text,
  operacao text,
  tabela_fonte text,
  coluna_alvo text,
  ordem integer DEFAULT 999,
  tipo_visualizacao text DEFAULT 'card'::text,
  agrupamento_tempo text DEFAULT 'mes'::text,
  CONSTRAINT kpis_personalizados_pkey PRIMARY KEY (id),
  CONSTRAINT kpis_personalizados_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT kpis_personalizados_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.lancamentos (
  id bigint NOT NULL DEFAULT nextval('lancamentos_id_seq'::regclass),
  descricao text NOT NULL,
  valor numeric NOT NULL,
  data_transacao date NOT NULL DEFAULT CURRENT_DATE,
  tipo text NOT NULL CHECK (tipo = ANY (ARRAY['Receita'::text, 'Despesa'::text])),
  status text NOT NULL DEFAULT 'Pendente'::text CHECK (status = ANY (ARRAY['Pendente'::text, 'Conciliado'::text, 'Pago'::text])),
  conta_id bigint NOT NULL,
  categoria_id bigint,
  empreendimento_id bigint,
  etapa_id bigint,
  pedido_compra_id bigint,
  funcionario_id bigint,
  created_at timestamp with time zone DEFAULT now(),
  data_vencimento date,
  data_pagamento date,
  parcela_info text,
  recorrencia_id bigint,
  favorecido_contato_id bigint,
  conciliado boolean DEFAULT false,
  fitid text,
  empresa_id bigint,
  criado_por_usuario_id uuid,
  observacao text,
  mes_competencia date,
  transferencia_id uuid,
  auditoria_verificado boolean NOT NULL DEFAULT false,
  organizacao_id bigint NOT NULL,
  parcela_grupo uuid,
  frequencia text,
  recorrencia_data_fim date,
  pluggy_transaction_id text UNIQUE,
  status_auditoria_ia text DEFAULT 'Nao Auditado'::text CHECK (status_auditoria_ia = ANY (ARRAY['Nao Auditado'::text, 'Pendente'::text, 'Aprovado'::text, 'Divergente'::text, 'Erro'::text])),
  CONSTRAINT lancamentos_pkey PRIMARY KEY (id),
  CONSTRAINT lancamentos_conta_id_fkey FOREIGN KEY (conta_id) REFERENCES public.contas_financeiras(id),
  CONSTRAINT lancamentos_categoria_id_fkey FOREIGN KEY (categoria_id) REFERENCES public.categorias_financeiras(id),
  CONSTRAINT lancamentos_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT lancamentos_etapa_id_fkey FOREIGN KEY (etapa_id) REFERENCES public.etapa_obra(id),
  CONSTRAINT lancamentos_pedido_compra_id_fkey FOREIGN KEY (pedido_compra_id) REFERENCES public.pedidos_compra(id),
  CONSTRAINT lancamentos_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT fk_recorrencia FOREIGN KEY (recorrencia_id) REFERENCES public.recorrencias(id),
  CONSTRAINT fk_favorecido_contato FOREIGN KEY (favorecido_contato_id) REFERENCES public.contatos(id),
  CONSTRAINT fk_lancamento_empresa FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT lancamentos_criado_por_usuario_id_fkey FOREIGN KEY (criado_por_usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT lancamentos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.lancamentos_anexos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  lancamento_id bigint NOT NULL,
  tipo_documento_id bigint,
  descricao text,
  caminho_arquivo text NOT NULL,
  nome_arquivo text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  organizacao_id bigint,
  CONSTRAINT lancamentos_anexos_pkey PRIMARY KEY (id),
  CONSTRAINT lancamentos_anexos_lancamento_id_fkey FOREIGN KEY (lancamento_id) REFERENCES public.lancamentos(id),
  CONSTRAINT lancamentos_anexos_tipo_documento_id_fkey FOREIGN KEY (tipo_documento_id) REFERENCES public.documento_tipos(id),
  CONSTRAINT lancamentos_anexos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.marcas_uploads (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  descricao text,
  caminho_arquivo text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT marcas_uploads_pkey PRIMARY KEY (id)
);
CREATE TABLE public.materiais (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empresa_fornecedor_id bigint,
  nome text,
  descricao text,
  unidade_medida text,
  preco_unitario numeric,
  Grupo text,
  Código da Composição text,
  Origem text,
  classificacao text NOT NULL DEFAULT 'Insumo'::text CHECK (classificacao = ANY (ARRAY['Insumo'::text, 'Equipamento'::text])),
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT materiais_pkey PRIMARY KEY (id),
  CONSTRAINT materiais_empresa_fornecedor_id_fkey FOREIGN KEY (empresa_fornecedor_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT materiais_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.meta_ads (
  id text NOT NULL,
  name text,
  adset_id text,
  campaign_id text,
  status text,
  creative_title text,
  creative_body text,
  thumbnail_url text,
  organizacao_id bigint NOT NULL,
  last_synced_at timestamp with time zone DEFAULT now(),
  created_time timestamp with time zone,
  insights jsonb,
  CONSTRAINT meta_ads_pkey PRIMARY KEY (id),
  CONSTRAINT meta_ads_adset_id_fkey FOREIGN KEY (adset_id) REFERENCES public.meta_adsets(id),
  CONSTRAINT meta_ads_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.meta_campaigns(id),
  CONSTRAINT meta_ads_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.meta_ads_historico (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  ad_id text NOT NULL,
  data_snapshot date NOT NULL DEFAULT CURRENT_DATE,
  spend numeric,
  impressions integer,
  clicks integer,
  reach integer,
  leads integer,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  ad_name text,
  campaign_name text,
  adset_name text,
  CONSTRAINT meta_ads_historico_pkey PRIMARY KEY (id),
  CONSTRAINT meta_ads_historico_ad_id_fkey FOREIGN KEY (ad_id) REFERENCES public.meta_ads(id),
  CONSTRAINT meta_ads_historico_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.meta_adsets (
  id text NOT NULL,
  name text,
  campaign_id text,
  status text,
  daily_budget bigint,
  lifetime_budget bigint,
  billing_event text,
  start_time timestamp with time zone,
  end_time timestamp with time zone,
  organizacao_id bigint NOT NULL,
  last_synced_at timestamp with time zone DEFAULT now(),
  CONSTRAINT meta_adsets_pkey PRIMARY KEY (id),
  CONSTRAINT meta_adsets_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.meta_campaigns(id),
  CONSTRAINT meta_adsets_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.meta_campaigns (
  id text NOT NULL,
  name text,
  objective text,
  status text,
  buying_type text,
  spend_cap bigint,
  account_id text,
  organizacao_id bigint NOT NULL,
  last_synced_at timestamp with time zone DEFAULT now(),
  CONSTRAINT meta_campaigns_pkey PRIMARY KEY (id),
  CONSTRAINT meta_campaigns_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.modelos_contrato (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  nome_modelo text NOT NULL,
  clausulas_html text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT modelos_contrato_pkey PRIMARY KEY (id),
  CONSTRAINT modelos_contrato_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT modelos_contrato_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.monitor_visitas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  pagina text NOT NULL,
  origem text,
  dispositivo text,
  visitante_id uuid,
  data_acesso timestamp with time zone DEFAULT now(),
  session_id uuid,
  utm_medium text,
  utm_campaign text,
  utm_content text,
  url_completa text,
  ip text,
  CONSTRAINT monitor_visitas_pkey PRIMARY KEY (id),
  CONSTRAINT monitor_visitas_visitante_id_fkey FOREIGN KEY (visitante_id) REFERENCES auth.users(id)
);
CREATE TABLE public.movimentacoes_estoque (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  estoque_id bigint NOT NULL,
  tipo text NOT NULL CHECK (tipo = ANY (ARRAY['Entrada por Compra'::text, 'Saída por Uso'::text, 'Retirada por Funcionário'::text, 'Devolução ao Estoque'::text, 'Baixa por Quebra'::text])),
  quantidade numeric NOT NULL,
  data_movimentacao timestamp with time zone NOT NULL DEFAULT now(),
  pedido_compra_id bigint,
  usuario_id uuid,
  etapa_id bigint,
  observacao text,
  funcionario_id bigint,
  organizacao_id bigint,
  CONSTRAINT movimentacoes_estoque_pkey PRIMARY KEY (id),
  CONSTRAINT movimentacoes_estoque_estoque_id_fkey FOREIGN KEY (estoque_id) REFERENCES public.estoque(id),
  CONSTRAINT movimentacoes_estoque_pedido_compra_id_fkey FOREIGN KEY (pedido_compra_id) REFERENCES public.pedidos_compra(id),
  CONSTRAINT movimentacoes_estoque_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT movimentacoes_estoque_etapa_id_fkey FOREIGN KEY (etapa_id) REFERENCES public.etapa_obra(id),
  CONSTRAINT movimentacoes_estoque_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT movimentacoes_estoque_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.notificacoes (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  user_id uuid NOT NULL,
  titulo text NOT NULL,
  mensagem text NOT NULL,
  link text,
  lida boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint,
  tipo text DEFAULT 'sistema'::text,
  enviar_push boolean DEFAULT false,
  icone text DEFAULT 'fa-bell'::text,
  CONSTRAINT notificacoes_pkey PRIMARY KEY (id),
  CONSTRAINT notificacoes_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT notificacoes_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.notification_subscriptions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  user_id uuid NOT NULL,
  organizacao_id bigint,
  endpoint text NOT NULL UNIQUE,
  subscription_data jsonb NOT NULL,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notification_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT notification_subscriptions_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT notification_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.ocorrencias (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint,
  atividade_id bigint,
  funcionario_id bigint,
  tipo text NOT NULL,
  descricao text NOT NULL,
  data_ocorrencia text,
  hora_ocorrencia text,
  severidade character varying DEFAULT 'Média'::character varying,
  resolvida boolean DEFAULT false,
  data_resolucao character varying,
  observacoes text,
  created_at timestamp with time zone DEFAULT now(),
  diario_obra_id bigint,
  organizacao_id bigint NOT NULL,
  CONSTRAINT ocorrencias_pkey PRIMARY KEY (id),
  CONSTRAINT ocorrencias_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT ocorrencias_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT fk_diario_obra FOREIGN KEY (diario_obra_id) REFERENCES public.diarios_obra(id),
  CONSTRAINT ocorrencias_atividade_id_fkey FOREIGN KEY (atividade_id) REFERENCES public.activities(id),
  CONSTRAINT ocorrencias_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.orcamento_itens (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  orcamento_id bigint NOT NULL,
  material_id bigint,
  descricao text NOT NULL,
  unidade text,
  quantidade numeric NOT NULL DEFAULT 1,
  preco_unitario numeric,
  custo_total numeric DEFAULT (quantidade * preco_unitario),
  categoria text DEFAULT 'Outros'::text,
  status_cotacao text DEFAULT 'Pendente de Cotação'::text,
  created_at timestamp with time zone DEFAULT now(),
  etapa_id bigint,
  ordem integer,
  subetapa_id bigint,
  organizacao_id bigint NOT NULL,
  sinapi_id bigint,
  CONSTRAINT orcamento_itens_pkey PRIMARY KEY (id),
  CONSTRAINT orcamento_itens_orcamento_id_fkey FOREIGN KEY (orcamento_id) REFERENCES public.orcamentos(id),
  CONSTRAINT orcamento_itens_material_id_fkey FOREIGN KEY (material_id) REFERENCES public.materiais(id),
  CONSTRAINT fk_etapa_obra FOREIGN KEY (etapa_id) REFERENCES public.etapa_obra(id),
  CONSTRAINT fk_subetapa FOREIGN KEY (subetapa_id) REFERENCES public.subetapas(id),
  CONSTRAINT orcamento_itens_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT fk_orcamento_itens_sinapi FOREIGN KEY (sinapi_id) REFERENCES public.sinapi(id)
);
CREATE TABLE public.orcamentos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  nome_orcamento text NOT NULL,
  versao integer DEFAULT 1,
  custo_total_previsto numeric DEFAULT 0,
  status text DEFAULT 'Em Elaboração'::text,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT orcamentos_pkey PRIMARY KEY (id),
  CONSTRAINT orcamentos_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT orcamentos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.organizacoes (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  public_form_slug text UNIQUE,
  CONSTRAINT organizacoes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.parcelas_adicionais (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  configuracao_venda_id bigint NOT NULL,
  valor numeric NOT NULL,
  data_pagamento date NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT parcelas_adicionais_pkey PRIMARY KEY (id),
  CONSTRAINT parcelas_adicionais_configuracao_venda_id_fkey FOREIGN KEY (configuracao_venda_id) REFERENCES public.configuracoes_venda(id)
);
CREATE TABLE public.pedidos_compra (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  solicitante_id uuid,
  comprador_id uuid,
  data_solicitacao timestamp with time zone DEFAULT now(),
  data_entrega_prevista date,
  status text DEFAULT 'Pedido Realizado'::text,
  justificativa text,
  valor_total_estimado numeric,
  titulo text,
  turno_entrega text,
  organizacao_id bigint NOT NULL,
  data_entrega_real date,
  observacoes text,
  fase_id uuid,
  CONSTRAINT pedidos_compra_pkey PRIMARY KEY (id),
  CONSTRAINT pedidos_compra_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT pedidos_compra_solicitante_id_fkey FOREIGN KEY (solicitante_id) REFERENCES public.usuarios(id),
  CONSTRAINT pedidos_compra_comprador_id_fkey FOREIGN KEY (comprador_id) REFERENCES public.usuarios(id),
  CONSTRAINT pedidos_compra_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT pedidos_compra_fase_id_fkey FOREIGN KEY (fase_id) REFERENCES public.pedidos_fases(id)
);
CREATE TABLE public.pedidos_compra_anexos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  pedido_compra_id bigint NOT NULL,
  caminho_arquivo text NOT NULL,
  descricao text,
  nome_arquivo text,
  created_at timestamp with time zone DEFAULT now(),
  usuario_id uuid,
  organizacao_id bigint,
  CONSTRAINT pedidos_compra_anexos_pkey PRIMARY KEY (id),
  CONSTRAINT pedidos_compra_anexos_pedido_compra_id_fkey FOREIGN KEY (pedido_compra_id) REFERENCES public.pedidos_compra(id),
  CONSTRAINT pedidos_compra_anexos_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id),
  CONSTRAINT fk_pedidos_compra_anexos_organizacao_id FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.pedidos_compra_historico_fases (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  pedido_compra_id bigint NOT NULL,
  fase_anterior_id uuid,
  fase_nova_id uuid,
  usuario_id uuid,
  organizacao_id bigint NOT NULL,
  data_movimentacao timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT pedidos_compra_historico_fases_pkey PRIMARY KEY (id),
  CONSTRAINT fk_historico_pedido FOREIGN KEY (pedido_compra_id) REFERENCES public.pedidos_compra(id),
  CONSTRAINT fk_historico_fase_anterior FOREIGN KEY (fase_anterior_id) REFERENCES public.pedidos_fases(id),
  CONSTRAINT fk_historico_fase_nova FOREIGN KEY (fase_nova_id) REFERENCES public.pedidos_fases(id),
  CONSTRAINT fk_historico_usuario FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.pedidos_compra_itens (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  pedido_compra_id bigint NOT NULL,
  orcamento_item_id bigint,
  material_id bigint,
  descricao_item text NOT NULL,
  quantidade_solicitada numeric NOT NULL,
  unidade_medida character varying,
  fornecedor_id bigint,
  preco_unitario_real numeric,
  custo_total_real numeric,
  etapa_id bigint,
  tipo_operacao text NOT NULL DEFAULT 'Compra'::text CHECK (tipo_operacao = ANY (ARRAY['Compra'::text, 'Aluguel'::text])),
  dias_aluguel integer,
  subetapa_id bigint,
  organizacao_id bigint,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pedidos_compra_itens_pkey PRIMARY KEY (id),
  CONSTRAINT pedidos_compra_itens_pedido_compra_id_fkey FOREIGN KEY (pedido_compra_id) REFERENCES public.pedidos_compra(id),
  CONSTRAINT pedidos_compra_itens_orcamento_item_id_fkey FOREIGN KEY (orcamento_item_id) REFERENCES public.orcamento_itens(id),
  CONSTRAINT pedidos_compra_itens_material_id_fkey FOREIGN KEY (material_id) REFERENCES public.materiais(id),
  CONSTRAINT pedidos_compra_itens_fornecedor_id_fkey FOREIGN KEY (fornecedor_id) REFERENCES public.contatos(id),
  CONSTRAINT pedidos_compra_itens_etapa_id_fkey FOREIGN KEY (etapa_id) REFERENCES public.etapa_obra(id),
  CONSTRAINT pedidos_compra_itens_subetapa_id_fkey FOREIGN KEY (subetapa_id) REFERENCES public.subetapas(id),
  CONSTRAINT fk_pedidos_compra_itens_organizacao_id FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.pedidos_compra_notas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  pedido_id bigint NOT NULL,
  usuario_id uuid,
  conteudo text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT pedidos_compra_notas_pkey PRIMARY KEY (id),
  CONSTRAINT fk_pedido FOREIGN KEY (pedido_id) REFERENCES public.pedidos_compra(id),
  CONSTRAINT fk_usuario FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT fk_organizacao FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.pedidos_compra_status_historico_legacy (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  pedido_compra_id bigint NOT NULL,
  status_anterior text,
  status_novo text NOT NULL,
  data_mudanca timestamp with time zone NOT NULL DEFAULT now(),
  alterado_por_usuario_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pedidos_compra_status_historico_legacy_pkey PRIMARY KEY (id),
  CONSTRAINT pedidos_compra_status_historico_pedido_compra_id_fkey FOREIGN KEY (pedido_compra_id) REFERENCES public.pedidos_compra(id),
  CONSTRAINT pedidos_compra_status_historico_alterado_por_usuario_id_fkey FOREIGN KEY (alterado_por_usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.pedidos_fases (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  organizacao_id integer NOT NULL,
  nome text NOT NULL,
  slug text NOT NULL,
  ordem integer NOT NULL,
  finalizado boolean DEFAULT false,
  CONSTRAINT pedidos_fases_pkey PRIMARY KEY (id)
);
CREATE TABLE public.permissoes (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcao_id bigint NOT NULL,
  recurso text NOT NULL,
  pode_ver boolean DEFAULT false,
  pode_criar boolean DEFAULT false,
  pode_editar boolean DEFAULT false,
  pode_excluir boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint,
  CONSTRAINT permissoes_pkey PRIMARY KEY (id),
  CONSTRAINT permissoes_funcao_id_fkey FOREIGN KEY (funcao_id) REFERENCES public.funcoes(id),
  CONSTRAINT permissoes_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.pluggy_webhook_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  event_type text,
  item_id text,
  payload jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pluggy_webhook_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.pontos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  data_hora timestamp without time zone NOT NULL,
  tipo_registro text,
  observacao text,
  created_at timestamp without time zone DEFAULT now(),
  abonado boolean DEFAULT false,
  motivo_abono text,
  editado_manualmente boolean DEFAULT false,
  editado_por_usuario_id uuid,
  organizacao_id bigint NOT NULL,
  CONSTRAINT pontos_pkey PRIMARY KEY (id),
  CONSTRAINT pontos_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT pontos_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT fk_editado_por_usuario FOREIGN KEY (editado_por_usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.produtos_empreendimento (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  tipo text,
  unidade text,
  area_m2 numeric,
  valor_base numeric,
  fator_reajuste_percentual numeric,
  valor_venda_calculado numeric,
  status text DEFAULT 'Disponível'::text CHECK (status = ANY (ARRAY['Disponível'::text, 'Vendido'::text, 'Reservado'::text])),
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  matricula text,
  preco_m2 numeric,
  CONSTRAINT produtos_empreendimento_pkey PRIMARY KEY (id),
  CONSTRAINT produtos_empreendimento_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT produtos_empreendimento_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.projetos_bim (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome_arquivo text NOT NULL,
  tamanho_bytes bigint,
  urn_autodesk text,
  caminho_storage text,
  status text DEFAULT 'Pendente'::text,
  criado_por uuid DEFAULT auth.uid(),
  criado_em timestamp with time zone DEFAULT now(),
  empreendimento_id bigint,
  empresa_id bigint,
  disciplina_id bigint,
  versao integer DEFAULT 1,
  descricao text,
  organizacao_id bigint DEFAULT 2,
  is_lixeira boolean DEFAULT false,
  CONSTRAINT projetos_bim_pkey PRIMARY KEY (id),
  CONSTRAINT projetos_bim_criado_por_fkey FOREIGN KEY (criado_por) REFERENCES auth.users(id),
  CONSTRAINT projetos_bim_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.cadastro_empresa(id),
  CONSTRAINT projetos_bim_disciplina_id_fkey FOREIGN KEY (disciplina_id) REFERENCES public.disciplinas_projetos(id),
  CONSTRAINT projetos_bim_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.quadro_de_areas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empreendimento_id bigint NOT NULL,
  pavimento_nome text NOT NULL,
  area_m2 numeric NOT NULL,
  ordem integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quadro_de_areas_pkey PRIMARY KEY (id),
  CONSTRAINT quadro_de_areas_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id)
);
CREATE TABLE public.rdo_fotos_uploads (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  diario_obra_id bigint NOT NULL,
  caminho_arquivo text NOT NULL,
  descricao text,
  created_at timestamp with time zone DEFAULT now(),
  tamanho_arquivo integer,
  organizacao_id bigint,
  CONSTRAINT rdo_fotos_uploads_pkey PRIMARY KEY (id),
  CONSTRAINT rdo_fotos_uploads_diario_obra_id_fkey FOREIGN KEY (diario_obra_id) REFERENCES public.diarios_obra(id),
  CONSTRAINT rdo_fotos_uploads_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.recorrencias (
  id bigint NOT NULL DEFAULT nextval('recorrencias_id_seq'::regclass),
  descricao text NOT NULL,
  valor numeric NOT NULL,
  frequencia text NOT NULL CHECK (frequencia = ANY (ARRAY['Diária'::text, 'Semanal'::text, 'Mensal'::text, 'Anual'::text])),
  data_inicio date NOT NULL,
  data_fim date,
  conta_id bigint NOT NULL,
  categoria_id bigint,
  empreendimento_id bigint,
  etapa_id bigint,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT recorrencias_pkey PRIMARY KEY (id),
  CONSTRAINT recorrencias_conta_id_fkey FOREIGN KEY (conta_id) REFERENCES public.contas_financeiras(id),
  CONSTRAINT recorrencias_categoria_id_fkey FOREIGN KEY (categoria_id) REFERENCES public.categorias_financeiras(id),
  CONSTRAINT recorrencias_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT recorrencias_etapa_id_fkey FOREIGN KEY (etapa_id) REFERENCES public.etapa_obra(id),
  CONSTRAINT recorrencias_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.regras_notificacao (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome_regra text NOT NULL,
  tabela_alvo text NOT NULL,
  evento text NOT NULL CHECK (evento = ANY (ARRAY['INSERT'::text, 'UPDATE'::text, 'DELETE'::text])),
  coluna_monitorada text,
  valor_gatilho text,
  funcoes_ids ARRAY,
  enviar_para_dono boolean DEFAULT false,
  titulo_template text NOT NULL,
  mensagem_template text NOT NULL,
  link_template text,
  ativo boolean DEFAULT true,
  organizacao_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  enviar_push boolean DEFAULT false,
  icone text DEFAULT 'fa-bell'::text,
  regras_avancadas jsonb,
  CONSTRAINT regras_notificacao_pkey PRIMARY KEY (id),
  CONSTRAINT fk_regras_organizacao FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.simulacoes (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contato_id bigint NOT NULL,
  empreendimento_id bigint NOT NULL,
  usuario_id uuid,
  status text NOT NULL DEFAULT 'Em negociação'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  valor_venda numeric,
  desconto_percentual numeric DEFAULT 0,
  desconto_valor numeric DEFAULT 0,
  entrada_percentual numeric DEFAULT 0,
  entrada_valor numeric DEFAULT 0,
  num_parcelas_entrada integer DEFAULT 1,
  data_primeira_parcela_entrada date,
  parcelas_obra_percentual numeric DEFAULT 0,
  parcelas_obra_valor numeric DEFAULT 0,
  num_parcelas_obra integer DEFAULT 1,
  data_primeira_parcela_obra date,
  saldo_remanescente_percentual numeric DEFAULT 0,
  saldo_remanescente_valor numeric DEFAULT 0,
  produto_id bigint,
  contrato_id bigint,
  corretor_id bigint,
  plano_proposta jsonb,
  produtos_proposta jsonb,
  organizacao_id bigint NOT NULL,
  CONSTRAINT simulacoes_pkey PRIMARY KEY (id),
  CONSTRAINT simulacoes_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT simulacoes_empreendimento_id_fkey FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id),
  CONSTRAINT simulacoes_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id),
  CONSTRAINT simulacoes_produto_id_fkey FOREIGN KEY (produto_id) REFERENCES public.produtos_empreendimento(id),
  CONSTRAINT simulacoes_contrato_id_fkey FOREIGN KEY (contrato_id) REFERENCES public.contratos(id),
  CONSTRAINT simulacoes_corretor_id_fkey FOREIGN KEY (corretor_id) REFERENCES public.contatos(id),
  CONSTRAINT simulacoes_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.sinapi (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  empresa_fornecedor_id bigint,
  nome text,
  descricao text,
  unidade_medida text,
  preco_unitario numeric,
  Grupo text,
  Código da Composição text,
  Origem text,
  classificacao text NOT NULL DEFAULT 'Insumo'::text CHECK (classificacao = ANY (ARRAY['Insumo'::text, 'Equipamento'::text])),
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT sinapi_pkey PRIMARY KEY (id)
);
CREATE TABLE public.stella_documentos_treinamento (
  id integer NOT NULL DEFAULT nextval('stella_documentos_treinamento_id_seq'::regclass),
  empreendimento_id integer NOT NULL,
  nome_arquivo character varying NOT NULL,
  status_treinamento character varying NOT NULL DEFAULT 'Pendente'::character varying,
  data_upload timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  data_ultimo_treinamento timestamp with time zone,
  mensagem_erro text,
  CONSTRAINT stella_documentos_treinamento_pkey PRIMARY KEY (id),
  CONSTRAINT fk_empreendimento FOREIGN KEY (empreendimento_id) REFERENCES public.empreendimentos(id)
);
CREATE TABLE public.subetapas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome_subetapa text NOT NULL,
  codigo_subetapa text,
  etapa_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL,
  CONSTRAINT subetapas_pkey PRIMARY KEY (id),
  CONSTRAINT fk_etapa FOREIGN KEY (etapa_id) REFERENCES public.etapa_obra(id),
  CONSTRAINT subetapas_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.tabelas_sistema (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome_tabela text NOT NULL UNIQUE,
  nome_exibicao text NOT NULL,
  modulo text DEFAULT 'Geral'::text,
  icone text DEFAULT 'fa-table'::text,
  ativo boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tabelas_sistema_pkey PRIMARY KEY (id)
);
CREATE TABLE public.telefones (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contato_id bigint NOT NULL,
  telefone text NOT NULL,
  tipo text,
  created_at timestamp with time zone DEFAULT now(),
  country_code character varying DEFAULT '+55'::character varying,
  organizacao_id bigint,
  CONSTRAINT telefones_pkey PRIMARY KEY (id),
  CONSTRAINT telefones_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT telefones_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.telefones_backup_faxina (
  id bigint,
  contato_id bigint,
  telefone text,
  tipo text,
  created_at timestamp with time zone,
  country_code character varying,
  organizacao_id bigint
);
CREATE TABLE public.termos_aceite (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  user_id uuid NOT NULL,
  termo_id bigint NOT NULL,
  ip_address text,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  organizacao_id bigint NOT NULL DEFAULT 2,
  CONSTRAINT termos_aceite_pkey PRIMARY KEY (id),
  CONSTRAINT termos_aceite_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT termos_aceite_termo_id_fkey FOREIGN KEY (termo_id) REFERENCES public.termos_uso(id),
  CONSTRAINT termos_aceite_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.termos_uso (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  tipo text NOT NULL DEFAULT 'CORRETOR'::text,
  conteudo text NOT NULL,
  versao integer NOT NULL,
  ativo boolean DEFAULT true,
  organizacao_id bigint DEFAULT 2,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT termos_uso_pkey PRIMARY KEY (id),
  CONSTRAINT termos_uso_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.usuario_preferencias_notificacao (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  usuario_id uuid NOT NULL,
  regra_id bigint NOT NULL,
  ativo boolean DEFAULT true,
  updated_at timestamp with time zone DEFAULT now(),
  canal_sistema boolean DEFAULT true,
  canal_push boolean DEFAULT true,
  organizacao_id bigint,
  CONSTRAINT usuario_preferencias_notificacao_pkey PRIMARY KEY (id),
  CONSTRAINT fk_pref_user FOREIGN KEY (usuario_id) REFERENCES auth.users(id),
  CONSTRAINT fk_pref_regra FOREIGN KEY (regra_id) REFERENCES public.regras_notificacao(id)
);
CREATE TABLE public.usuarios (
  id uuid NOT NULL,
  funcionario_id bigint UNIQUE,
  email text,
  nome text,
  sobrenome text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  funcao_id bigint,
  avatar_url text,
  aceitou_termos boolean DEFAULT false,
  data_aceite_termos timestamp with time zone,
  sidebar_position text NOT NULL DEFAULT 'left'::text,
  organizacao_id bigint NOT NULL,
  cotacoes_visiveis jsonb NOT NULL DEFAULT '[]'::jsonb,
  mostrar_barra_cotacoes boolean NOT NULL DEFAULT true,
  preferencias_notificacao jsonb DEFAULT '{"sistema": true, "comercial": true, "financeiro": true, "operacional": true}'::jsonb,
  data_exclusao timestamp with time zone,
  ultimo_acesso timestamp with time zone,
  CONSTRAINT usuarios_pkey PRIMARY KEY (id),
  CONSTRAINT usuarios_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id),
  CONSTRAINT usuarios_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT usuarios_funcao_id_fkey FOREIGN KEY (funcao_id) REFERENCES public.funcoes(id),
  CONSTRAINT usuarios_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.vales_agendados (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  funcionario_id bigint NOT NULL,
  lancamento_id bigint NOT NULL,
  periodo_inicio date NOT NULL,
  periodo_fim date NOT NULL,
  data_pagamento_agendada date NOT NULL,
  valor_projetado numeric NOT NULL,
  valor_final_ajustado numeric,
  status text NOT NULL DEFAULT 'Agendado'::text,
  criado_em timestamp with time zone DEFAULT now(),
  processado_em timestamp with time zone,
  organizacao_id bigint NOT NULL,
  CONSTRAINT vales_agendados_pkey PRIMARY KEY (id),
  CONSTRAINT vales_agendados_funcionario_id_fkey FOREIGN KEY (funcionario_id) REFERENCES public.funcionarios(id),
  CONSTRAINT vales_agendados_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT vales_agendados_lancamento_id_fkey FOREIGN KEY (lancamento_id) REFERENCES public.lancamentos(id)
);
CREATE TABLE public.variaveis_virtuais (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  tabela_gatilho text NOT NULL,
  nome_variavel text NOT NULL,
  coluna_origem text NOT NULL,
  tabela_destino text NOT NULL,
  coluna_chave_destino text DEFAULT 'id'::text,
  coluna_retorno text NOT NULL,
  organizacao_id bigint DEFAULT 2,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT variaveis_virtuais_pkey PRIMARY KEY (id)
);
CREATE TABLE public.whatsapp_attachments (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contato_id bigint NOT NULL,
  message_id text,
  storage_path text NOT NULL,
  public_url text NOT NULL,
  file_name text,
  file_type text,
  file_size bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT whatsapp_attachments_pkey PRIMARY KEY (id),
  CONSTRAINT whatsapp_attachments_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id)
);
CREATE TABLE public.whatsapp_broadcast_lists (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nome text NOT NULL,
  descricao text,
  filtros_usados jsonb,
  criado_por uuid,
  organizacao_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  is_dynamic boolean DEFAULT false,
  CONSTRAINT whatsapp_broadcast_lists_pkey PRIMARY KEY (id),
  CONSTRAINT fk_broadcast_organizacao FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT fk_broadcast_criador FOREIGN KEY (criado_por) REFERENCES auth.users(id)
);
CREATE TABLE public.whatsapp_conversations (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  phone_number text NOT NULL UNIQUE,
  updated_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  contato_id bigint,
  is_archived boolean DEFAULT false,
  organizacao_id bigint,
  last_message_id bigint,
  unread_count integer DEFAULT 0,
  last_direction text DEFAULT 'inbound'::text,
  last_status text DEFAULT 'delivered'::text,
  last_message_direction text DEFAULT 'inbound'::text,
  CONSTRAINT whatsapp_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT whatsapp_conversations_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT whatsapp_conversations_last_message_id_fkey FOREIGN KEY (last_message_id) REFERENCES public.whatsapp_messages(id),
  CONSTRAINT whatsapp_conversations_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id)
);
CREATE TABLE public.whatsapp_list_members (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  lista_id bigint NOT NULL,
  contato_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT whatsapp_list_members_pkey PRIMARY KEY (id),
  CONSTRAINT fk_member_lista FOREIGN KEY (lista_id) REFERENCES public.whatsapp_broadcast_lists(id),
  CONSTRAINT fk_member_contato FOREIGN KEY (contato_id) REFERENCES public.contatos(id)
);
CREATE TABLE public.whatsapp_messages (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  contato_id bigint,
  enterprise_id bigint,
  message_id text,
  conversation_id text,
  sender_id text,
  receiver_id text,
  content text,
  sent_at timestamp with time zone,
  direction text,
  status text,
  raw_payload jsonb,
  created_at timestamp with time zone DEFAULT now(),
  is_read boolean NOT NULL DEFAULT false,
  organizacao_id bigint,
  conversation_record_id bigint,
  media_url text,
  broadcast_id bigint,
  nome_remetente text,
  error_message text,
  CONSTRAINT whatsapp_messages_pkey PRIMARY KEY (id),
  CONSTRAINT whatsapp_messages_contato_id_fkey FOREIGN KEY (contato_id) REFERENCES public.contatos(id),
  CONSTRAINT whatsapp_messages_organizacao_id_fkey FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id),
  CONSTRAINT whatsapp_messages_conversation_record_id_fkey FOREIGN KEY (conversation_record_id) REFERENCES public.whatsapp_conversations(id),
  CONSTRAINT whatsapp_messages_broadcast_id_fkey FOREIGN KEY (broadcast_id) REFERENCES public.whatsapp_scheduled_broadcasts(id)
);
CREATE TABLE public.whatsapp_scheduled_broadcasts (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  lista_id bigint NOT NULL,
  template_name text NOT NULL,
  language text NOT NULL,
  variables jsonb,
  full_text_base text,
  components jsonb,
  scheduled_at timestamp with time zone NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'paused'::text, 'stopped'::text])),
  organizacao_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_at timestamp with time zone DEFAULT now(),
  total_contacts integer DEFAULT 0,
  processed_count integer DEFAULT 0,
  success_count integer DEFAULT 0,
  failed_count integer DEFAULT 0,
  started_at timestamp with time zone,
  stopped_at timestamp with time zone,
  CONSTRAINT whatsapp_scheduled_broadcasts_pkey PRIMARY KEY (id),
  CONSTRAINT fk_lista_schedule FOREIGN KEY (lista_id) REFERENCES public.whatsapp_broadcast_lists(id),
  CONSTRAINT fk_org_schedule FOREIGN KEY (organizacao_id) REFERENCES public.organizacoes(id)
);
CREATE TABLE public.whatsapp_webhook_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  log_level text,
  message text,
  payload jsonb,
  CONSTRAINT whatsapp_webhook_logs_pkey PRIMARY KEY (id)
);